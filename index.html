<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V-Quest ¬∑ Absolute Value Transformations</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#0b0e17;--bg-card:rgba(15,20,35,0.92);--bg-raised:rgba(25,33,56,0.85);
--border:rgba(80,120,200,0.2);--text:#e0e8f5;--text-dim:#7a8ba8;--text-bright:#fff;
--accent:#ff6b5a;--accent-glow:rgba(255,107,90,0.3);
--green:#34d399;--green-glow:rgba(52,211,153,0.3);
--yellow:#fbbf24;--blue:#60a5fa;--purple:#a78bfa;--cyan:#22d3ee;
--font-display:'Orbitron',sans-serif;--font-body:'Outfit',system-ui,sans-serif;
--font-mono:'DM Mono','Menlo',monospace;
--radius:12px;--radius-sm:8px;--tr:0.2s ease;
}
html,body{height:100%;font-family:var(--font-body);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overflow:hidden}
.starfield{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.starfield canvas{width:100%;height:100%}
.screen{position:fixed;inset:0;display:none;flex-direction:column;z-index:1}
.screen.active{display:flex}
.overlay{position:fixed;inset:0;background:rgba(5,8,18,0.88);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:100;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Buttons */
.btn{font-family:var(--font-body);font-weight:600;font-size:.95rem;border:none;border-radius:var(--radius);cursor:pointer;transition:all var(--tr);padding:.7rem 1.6rem;letter-spacing:.02em}
.btn:active{transform:scale(.96)}
.btn-primary{background:linear-gradient(135deg,var(--accent),#ff8a5c);color:#fff;box-shadow:0 2px 16px var(--accent-glow),inset 0 1px 0 rgba(255,255,255,.15);text-shadow:0 1px 2px rgba(0,0,0,.3)}
.btn-primary:hover{box-shadow:0 4px 24px var(--accent-glow);transform:translateY(-1px)}
.btn-secondary{background:var(--bg-raised);color:var(--text);border:1px solid var(--border);backdrop-filter:blur(4px)}
.btn-secondary:hover{background:rgba(40,50,80,.8);border-color:var(--blue)}
.btn-sm{padding:.45rem 1rem;font-size:.85rem}
.btn-cancel{background:var(--bg-raised);color:var(--text-dim);border:1px solid var(--border)}
.btn-confirm{background:linear-gradient(135deg,var(--accent),#ff8a5c);color:#fff}
.btn-link{background:none;border:none;color:var(--text-dim);font-family:var(--font-body);font-size:.9rem;cursor:pointer;text-decoration:none;opacity:.8;transition:all .2s}
.btn-link:hover{color:var(--cyan);opacity:1}
.btn-icon{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-dim);width:36px;height:36px;display:grid;place-items:center;cursor:pointer;transition:all var(--tr)}
.btn-icon:hover{background:var(--bg-raised);color:var(--cyan);border-color:var(--cyan)}
.btn-back{background:none;border:none;color:var(--text-dim);font-family:var(--font-body);font-size:.9rem;cursor:pointer;margin-bottom:1.5rem}
.btn-back:hover{color:var(--cyan)}

/* Title Screen */
#title-screen{align-items:center;justify-content:center;position:relative;overflow:hidden}
.title-content{text-align:center;position:relative;z-index:2;animation:titleEnter .8s cubic-bezier(.16,1,.3,1)}
@keyframes titleEnter{from{opacity:0;transform:translateY(30px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.title-badge{font-family:var(--font-display);font-size:.6rem;font-weight:600;letter-spacing:.25em;text-transform:uppercase;color:var(--cyan);background:rgba(34,211,238,.08);padding:.4rem 1.2rem;border-radius:50px;display:inline-block;margin-bottom:1.5rem;border:1px solid rgba(34,211,238,.15);animation:badgePulse 3s ease-in-out infinite}
@keyframes badgePulse{0%,100%{box-shadow:0 0 8px rgba(34,211,238,.1)}50%{box-shadow:0 0 20px rgba(34,211,238,.2)}}
.title-heading{font-family:var(--font-display);font-size:clamp(3.5rem,10vw,7rem);font-weight:900;line-height:1;margin-bottom:1rem;letter-spacing:-.02em}
.title-v{color:var(--accent);text-shadow:0 0 30px rgba(255,107,90,.4),0 0 60px rgba(255,107,90,.15)}
.title-dash{color:rgba(255,255,255,.15);margin:0 .05em;font-weight:300}
.title-quest{color:var(--text-bright);text-shadow:0 0 30px rgba(96,165,250,.3)}
.title-subtitle{color:var(--text-dim);font-size:1.1rem;line-height:1.7;margin-bottom:1rem;font-weight:300;max-width:400px;margin-left:auto;margin-right:auto}
.title-story{font-size:.85rem;color:var(--cyan);opacity:.7;max-width:420px;margin:0 auto 1.5rem;line-height:1.6;font-style:italic}
.title-equation{font-family:var(--font-mono);font-size:1.15rem;color:var(--blue);background:var(--bg-card);display:inline-block;padding:.6rem 1.6rem;border-radius:var(--radius);border:1px solid var(--border);margin-bottom:2.4rem;letter-spacing:.03em;box-shadow:0 0 10px rgba(96,165,250,.15)}
.title-buttons{display:flex;gap:.8rem;justify-content:center;margin-bottom:1.5rem}
.title-how{margin-top:.5rem}

/* How to Play */
#how-screen{align-items:center;justify-content:center;overflow-y:auto;padding:2rem}
.how-content{max-width:640px;width:100%;animation:titleEnter .4s ease}
.how-content h2{font-family:var(--font-display);font-size:1.6rem;font-weight:700;margin-bottom:1.5rem;letter-spacing:.02em}
.how-grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:1.8rem}
.how-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;backdrop-filter:blur(4px)}
.how-icon{font-size:1.5rem;margin-bottom:.5rem}
.how-card h3{font-size:.95rem;font-weight:600;margin-bottom:.3rem}
.how-card p{font-size:.82rem;color:var(--text-dim);line-height:1.5}
.how-types h3{font-size:1rem;font-weight:600;margin-bottom:.7rem}
.how-type{display:flex;align-items:flex-start;gap:.8rem;margin-bottom:.8rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem 1.2rem}
.how-type p{font-size:.82rem;color:var(--text-dim);line-height:1.5}
.how-type-badge{font-family:var(--font-display);font-size:.55rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:.3rem .7rem;border-radius:50px;white-space:nowrap;flex-shrink:0;background:rgba(96,165,250,.1);color:var(--blue);border:1px solid rgba(96,165,250,.2)}

/* Game Screen */
#game-screen{display:none}
#game-screen.active{display:flex;flex-direction:column}
.game-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem .8rem;border-bottom:1px solid var(--border);background:var(--bg-card);backdrop-filter:blur(8px);flex-shrink:0;z-index:5}
.header-left,.header-right{display:flex;align-items:center;gap:.5rem}
.level-info{display:flex;align-items:center;gap:.5rem}
.level-badge{font-family:var(--font-display);font-size:.5rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:.25rem .6rem;border-radius:50px;background:rgba(96,165,250,.1);color:var(--blue);border:1px solid rgba(96,165,250,.2)}
.level-number{font-family:var(--font-display);font-size:.75rem;font-weight:500;color:var(--text-dim);letter-spacing:.05em}
.rank-badge{font-family:var(--font-display);font-size:.5rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;padding:.2rem .5rem;border-radius:50px;background:rgba(251,191,36,.1);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.stat-chip{display:flex;align-items:center;gap:.3rem;background:rgba(255,255,255,.03);padding:.25rem .6rem;border-radius:var(--radius-sm);border:1px solid var(--border)}
.stat-label{font-family:var(--font-display);font-size:.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em}
.stat-value{font-family:var(--font-mono);font-size:.85rem;font-weight:500}
.stat-value.score-val{color:var(--yellow)}
.stat-value.tries-val{color:var(--cyan)}

/* Mission Bar */
.mission-bar{display:flex;align-items:center;justify-content:center;gap:.6rem;padding:.55rem 1rem;background:linear-gradient(90deg,rgba(96,165,250,.06),rgba(34,211,238,.08),rgba(96,165,250,.06));border-bottom:1px solid var(--border);flex-shrink:0;text-align:center;position:relative;overflow:hidden}
.mission-bar::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(34,211,238,.04),transparent);animation:mSweep 4s ease-in-out infinite}
@keyframes mSweep{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.mission-icon{font-size:1rem;position:relative;z-index:1}
.mission-text{font-family:var(--font-mono);font-size:clamp(.68rem,1.8vw,.82rem);font-weight:400;letter-spacing:.01em;line-height:1.4;color:var(--cyan);position:relative;z-index:1}

/* Canvas */
.canvas-wrapper{flex:1;position:relative;overflow:hidden}
#graph-canvas{display:block;width:100%;height:100%}
.combo-display{position:absolute;top:8px;right:10px;font-family:var(--font-display);font-size:.65rem;color:var(--yellow);letter-spacing:.08em;opacity:0;transition:opacity .3s;text-shadow:0 0 10px rgba(251,191,36,.4);z-index:5}
.combo-display.visible{opacity:1}
.shake{animation:shakeIt .4s ease}
@keyframes shakeIt{0%,100%{transform:translate(0)}15%{transform:translate(-4px,2px)}30%{transform:translate(3px,-3px)}45%{transform:translate(-2px,1px)}60%{transform:translate(2px,-1px)}75%{transform:translate(-1px,2px)}}

/* Input Modals */
.input-modal{position:absolute;z-index:50;left:50%;bottom:80px;transform:translateX(-50%);animation:popIn .2s cubic-bezier(.16,1,.3,1)}
@keyframes popIn{from{opacity:0;transform:translateX(-50%) scale(.9) translateY(8px)}to{opacity:1;transform:translateX(-50%) scale(1) translateY(0)}}
.input-modal-inner{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem 1.2rem;box-shadow:0 12px 40px rgba(0,0,0,.5),0 0 10px rgba(96,165,250,.15);backdrop-filter:blur(12px);display:flex;flex-direction:column;gap:.6rem;min-width:200px}
.input-label{font-family:var(--font-display);font-size:.65rem;color:var(--text-dim);letter-spacing:.1em;text-transform:uppercase}
.input-number{font-family:var(--font-mono);font-size:1.3rem;text-align:center;width:100%;padding:.5rem;background:rgba(0,0,0,.3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);outline:none;transition:border-color var(--tr)}
.input-number:focus{border-color:var(--cyan);box-shadow:0 0 12px rgba(34,211,238,.15)}
.input-actions{display:flex;gap:.5rem;justify-content:flex-end}

/* Fraction Input */
.fraction-input-wrap{display:flex;align-items:center;gap:.6rem;justify-content:center}
.fraction-box{display:flex;flex-direction:column;align-items:center;gap:0}
.fraction-box input{font-family:var(--font-mono);font-size:1.2rem;text-align:center;width:80px;padding:.35rem .3rem;background:rgba(0,0,0,.3);border:1.5px solid var(--border);color:var(--text);outline:none;transition:border-color var(--tr)}
.fraction-box input:focus{border-color:var(--cyan);box-shadow:0 0 12px rgba(34,211,238,.15)}
.fraction-box input::placeholder{color:var(--text-dim);font-size:.72rem;font-family:var(--font-body);font-style:italic;opacity:.6}
.frac-num{border-radius:var(--radius-sm) var(--radius-sm) 0 0;border-bottom:none!important}
.frac-line{width:80px;height:2px;background:var(--cyan);opacity:.6}
.frac-den{border-radius:0 0 var(--radius-sm) var(--radius-sm);border-top:none!important}
.frac-sign{font-family:var(--font-mono);font-size:1.4rem;color:var(--text-dim);cursor:pointer;user-select:none;padding:.3rem;border-radius:var(--radius-sm);transition:all .15s}
.frac-sign:hover{color:var(--accent);background:rgba(255,107,90,.08)}
.frac-sign.negative{color:var(--accent)}
.frac-preview{font-family:var(--font-mono);font-size:.8rem;color:var(--text-dim);text-align:center;min-height:1.1rem}

/* Equation Bar */
.equation-bar{display:flex;align-items:center;justify-content:center;gap:.8rem;padding:.6rem .8rem;background:var(--bg-card);border-top:1px solid var(--border);backdrop-filter:blur(8px);flex-shrink:0;flex-wrap:wrap;z-index:5}
.equation-container{font-family:var(--font-mono);font-size:clamp(1rem,2.8vw,1.3rem);display:flex;align-items:center;gap:.12rem}
.eq-text{color:var(--text-dim)}
.eq-variable{display:inline-flex;align-items:center;justify-content:center;min-width:2.2rem;padding:.2rem .45rem;background:rgba(255,255,255,.03);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-weight:500;cursor:pointer;transition:all var(--tr);user-select:none;text-align:center}
.eq-variable:hover,.eq-variable:focus{border-color:var(--cyan);background:rgba(34,211,238,.06);box-shadow:0 0 12px rgba(34,211,238,.15);outline:none}
.eq-variable.active{border-color:var(--cyan);background:rgba(34,211,238,.08);box-shadow:0 0 16px rgba(34,211,238,.2)}
.eq-variable.placeholder{color:var(--accent);font-style:italic;opacity:.85;border-color:rgba(255,107,90,.4);background:rgba(255,107,90,.04);animation:plPulse 2s ease-in-out infinite}
@keyframes plPulse{0%,100%{box-shadow:0 0 0 2px transparent}50%{box-shadow:0 0 12px var(--accent-glow)}}
.btn-try{background:linear-gradient(135deg,var(--green),#2dd4bf);color:#fff;font-weight:600;box-shadow:0 2px 16px var(--green-glow);padding:.5rem 1.2rem;font-size:.85rem;text-shadow:0 1px 2px rgba(0,0,0,.2)}
.btn-try:hover{box-shadow:0 4px 24px var(--green-glow);transform:translateY(-1px)}
.btn-try:disabled{opacity:.5;cursor:not-allowed;transform:none;filter:saturate(.5)}

/* Feedback */
.feedback-toast{position:absolute;bottom:5rem;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:.65rem 1.2rem;display:flex;align-items:center;gap:.5rem;font-size:.85rem;box-shadow:0 8px 30px rgba(0,0,0,.4);backdrop-filter:blur(8px);z-index:30;animation:toastIn .3s ease;max-width:90%;text-align:center}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.feedback-toast.success{border-color:var(--green);box-shadow:0 0 20px var(--green-glow)}
.feedback-toast.fail{border-color:var(--accent)}

/* Overlays */
.overlay-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:2.5rem;text-align:center;max-width:440px;width:90%;animation:oPop .4s cubic-bezier(.16,1,.3,1);display:flex;flex-direction:column;gap:.7rem;align-items:center;box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 20px rgba(96,165,250,.2);backdrop-filter:blur(12px);position:relative;overflow:hidden}
@keyframes oPop{from{opacity:0;transform:scale(.85) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.overlay-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);opacity:.5}
.overlay-card h2{font-family:var(--font-display);font-size:1.3rem;font-weight:700;letter-spacing:.04em}
.overlay-card p{color:var(--text-dim);font-size:.88rem;line-height:1.5}
.overlay-fail{border-color:rgba(255,107,90,.2)}
.overlay-fail::before{background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.success-msg{font-size:1.15rem!important;font-weight:600;color:var(--green)!important;line-height:1.5;text-shadow:0 0 20px rgba(52,211,153,.3)}
.fail-msg{font-size:1.05rem!important;font-weight:600;color:var(--accent)!important;line-height:1.5}
.fail-answer{font-family:var(--font-mono);font-size:.82rem!important;color:var(--text-dim)!important}
.story-text{font-size:.78rem;color:var(--cyan);opacity:.7;font-style:italic;line-height:1.5}
.stars-row{display:flex;gap:.5rem;margin-bottom:.3rem}
.star{font-size:2.2rem;color:rgba(255,255,255,.08);transition:color .3s,transform .3s,text-shadow .3s}
.star.earned{color:var(--yellow);text-shadow:0 0 20px rgba(251,191,36,.5);animation:starPop .4s cubic-bezier(.16,1,.3,1)}
@keyframes starPop{0%{transform:scale(.3) rotate(-20deg)}60%{transform:scale(1.3) rotate(5deg)}100%{transform:scale(1) rotate(0)}}
.complete-stats{width:100%;display:flex;justify-content:center;gap:2rem;margin:.5rem 0}
.complete-stats>div{text-align:center}
.cs-label{display:block;font-family:var(--font-display);font-size:.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.2rem}
.cs-value{font-family:var(--font-mono);font-size:1.1rem;font-weight:500}
.points-earned{color:var(--yellow);text-shadow:0 0 10px rgba(251,191,36,.3)}
.point-popup{position:absolute;z-index:60;pointer-events:none;font-family:var(--font-display);font-weight:800;font-size:1.5rem;color:var(--yellow);text-shadow:0 0 20px rgba(251,191,36,.5);animation:ptFloat 1.2s ease-out forwards}
@keyframes ptFloat{0%{opacity:1;transform:translateY(0) scale(1)}60%{opacity:1;transform:translateY(-40px) scale(1.1)}100%{opacity:0;transform:translateY(-70px) scale(.8)}}

@media(max-width:600px){
.how-grid{grid-template-columns:1fr}
.game-header{padding:.4rem .6rem}
.equation-bar{gap:.4rem;padding:.5rem .6rem}
.overlay-card{padding:1.8rem}
.stat-chip{padding:.2rem .4rem}
.mission-bar{padding:.4rem .6rem}
.fraction-box input{width:60px;font-size:1rem}
.frac-line{width:60px}
}
</style>
</head>
<body>
<div class="starfield"><canvas id="starfield-canvas"></canvas></div>

<div id="title-screen" class="screen active">
<div class="title-content">
<div class="title-badge">‚ö° ALGEBRA 1 DEEP SPACE DIVISION ‚ö°</div>
<h1 class="title-heading"><span class="title-v">V</span><span class="title-dash">‚Äî</span><span class="title-quest">Quest</span></h1>
<p class="title-subtitle">Master absolute value transformations<br>to navigate the Glaxonian frontier.</p>
<p class="title-story">"Cadet ‚Äî the Glaxonian Math Corps needs you. Only those who master the V-function can pilot a saucer through the coordinate nebula."<br>‚Äî Commander Vertex, Glaxonia Prime 3</p>
<div class="title-equation">y = a|x ‚àí h| + k</div>
<div class="title-buttons">
<button id="btn-new-game" class="btn btn-primary" onclick="Game.startNew()">üöÄ Begin Mission</button>
<button id="btn-continue" class="btn btn-secondary" onclick="Game.continueGame()" style="display:none">‚ñ∂ Continue</button>
</div>
<div class="title-how"><button class="btn-link" onclick="Game.showHow()">‚¨á How to Play</button></div>
</div>
</div>

<div id="how-screen" class="screen">
<div class="how-content">
<button class="btn-back" onclick="Game.showTitle()">‚Üê Back to Base</button>
<h2>Mission Briefing</h2>
<div class="how-grid">
<div class="how-card"><div class="how-icon">üéØ</div><h3>Your Mission</h3><p>Each level gives you coordinates. Land your saucer's vertex on the red target, then adjust slope so the V-lasers hit the blue target.</p></div>
<div class="how-card"><div class="how-icon">‚úèÔ∏è</div><h3>Set Variables</h3><p>Click <strong>a</strong>, <strong>h</strong>, or <strong>k</strong> in the equation. For <strong>a</strong> (slope), enter Rise √∑ Run.</p></div>
<div class="how-card"><div class="how-icon">üõ∏</div><h3>Launch!</h3><p>Click <strong>Try Solution</strong> to send your saucer. Watch it fly, charge up, and fire its V-lasers!</p></div>
<div class="how-card"><div class="how-icon">‚≠ê</div><h3>Scoring</h3><p><strong>2 tries</strong> per level. First-try = 2 stars + combo bonus!</p></div>
</div>
<div class="how-types"><h3>The V-Function</h3>
<div class="how-type"><span class="how-type-badge">y = a|x ‚àí h| + k</span><p><strong>h</strong> shifts left/right, <strong>k</strong> shifts up/down, <strong>a</strong> controls steepness. Fractions like ¬Ω make it wider!</p></div>
</div>
</div>
</div>

<div id="game-screen" class="screen">
<header class="game-header">
<div class="header-left">
<button class="btn-icon" onclick="Game.showTitle()" title="Menu"><svg width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></button>
<div class="level-info"><span class="level-badge" id="level-type-badge">Mission</span><span class="level-number" id="level-number">Level 1</span></div>
<span class="rank-badge" id="rank-badge">Cadet</span>
</div>
<div class="header-right">
<div class="stat-chip"><span class="stat-label">Score</span><span class="stat-value score-val" id="score-display">0</span></div>
<div class="stat-chip"><span class="stat-label">Tries</span><span class="stat-value tries-val" id="attempts-display">2</span></div>
</div>
</header>
<div class="mission-bar"><span class="mission-icon">üõ∏</span><span class="mission-text" id="mission-text">Loading mission...</span></div>
<div class="canvas-wrapper" id="canvas-wrapper">
<canvas id="graph-canvas"></canvas>
<div class="combo-display" id="combo-display">üî• COMBO x3</div>
</div>
<div class="input-modal" id="input-modal" style="display:none"><div class="input-modal-inner">
<label class="input-label" id="input-label">Set value for h:</label>
<input type="number" id="input-field" class="input-number" step="1" autocomplete="off">
<div class="input-actions"><button class="btn btn-sm btn-cancel" onclick="Game.cancelInput()">Cancel</button><button class="btn btn-sm btn-confirm" onclick="Game.confirmInput()">Set</button></div>
</div></div>
<div class="input-modal" id="frac-modal" style="display:none"><div class="input-modal-inner">
<label class="input-label">Set slope (a) ‚Äî Rise / Run:</label>
<div class="fraction-input-wrap">
<span class="frac-sign" id="frac-sign" onclick="Game.toggleFracSign()" title="Toggle sign">+</span>
<div class="fraction-box">
<input type="number" id="frac-num" class="frac-num" placeholder="Rise" step="1" min="0" autocomplete="off">
<div class="frac-line"></div>
<input type="number" id="frac-den" class="frac-den" placeholder="Run" step="1" min="1" autocomplete="off">
</div>
</div>
<div class="frac-preview" id="frac-preview"></div>
<div class="input-actions"><button class="btn btn-sm btn-cancel" onclick="Game.cancelInput()">Cancel</button><button class="btn btn-sm btn-confirm" onclick="Game.confirmFraction()">Set</button></div>
</div></div>
<div class="feedback-toast" id="feedback-toast" style="display:none"><span id="feedback-icon"></span><span id="feedback-msg"></span></div>
<div class="equation-bar">
<div class="equation-container">
<span class="eq-text">y =&nbsp;</span><span class="eq-variable" id="eq-a" tabindex="0" role="button" aria-label="Edit a value">a</span>
<span class="eq-text">&nbsp;|x ‚àí&nbsp;</span><span class="eq-variable" id="eq-h" tabindex="0" role="button" aria-label="Edit h value">h</span>
<span class="eq-text">| +&nbsp;</span><span class="eq-variable" id="eq-k" tabindex="0" role="button" aria-label="Edit k value">k</span>
</div>
<button class="btn btn-try" id="btn-try" onclick="Game.trySolution()">Try Solution üõ∏</button>
</div>
</div>

<div id="level-complete" class="overlay" style="display:none"><div class="overlay-card">
<div class="stars-row" id="stars-row"><span class="star">‚òÖ</span><span class="star">‚òÖ</span></div>
<h2 id="complete-title">Mission Success!</h2>
<p id="complete-msg" class="success-msg">All of Glaxonia Prime 3 salutes you.</p>
<p id="story-progress" class="story-text"></p>
<div class="complete-stats">
<div><span class="cs-label">Points</span><span class="cs-value points-earned" id="complete-points">+100</span></div>
<div><span class="cs-label">Attempts</span><span class="cs-value" id="complete-attempts">1/2</span></div>
<div><span class="cs-label">Combo</span><span class="cs-value" id="complete-combo" style="color:var(--yellow)">x1</span></div>
</div>
<button class="btn btn-primary" onclick="Game.nextLevel()">Next Mission ‚Üí</button>
</div></div>

<div id="level-failed" class="overlay" style="display:none"><div class="overlay-card overlay-fail">
<h2>Mission Failure</h2>
<p id="fail-msg" class="fail-msg">Glaxonon police put you in Xinothropic Galactic Jail for 2 parsecs.</p>
<p id="fail-answer" class="fail-answer"></p>
<p id="fail-story" class="story-text"></p>
<button class="btn btn-primary" onclick="Game.nextLevel()">Next Mission ‚Üí</button>
<button class="btn btn-secondary" onclick="Game.retryLevel()">Retry Mission</button>
</div></div>

<script>
/* Starfield */
(function(){
const sc=document.getElementById('starfield-canvas'),sx=sc.getContext('2d');
let stars=[];const N=180;
function rs(){sc.width=innerWidth;sc.height=innerHeight;if(!stars.length)mk()}
function mk(){stars=[];for(let i=0;i<N;i++)stars.push({x:Math.random()*sc.width,y:Math.random()*sc.height,r:.3+Math.random()*1.8,sp:.02+Math.random()*.08,tw:Math.random()*Math.PI*2,h:200+Math.random()*60})}
function dr(){sx.clearRect(0,0,sc.width,sc.height);const t=Date.now()*.0001;
for(let i=0;i<3;i++){const nx=sc.width*(.3+.4*Math.sin(t+i*2)),ny=sc.height*(.3+.4*Math.cos(t*.7+i*1.5)),g=sx.createRadialGradient(nx,ny,0,nx,ny,sc.width*.35),h=(220+i*40)%360;g.addColorStop(0,`hsla(${h},60%,30%,.04)`);g.addColorStop(.5,`hsla(${h},50%,20%,.02)`);g.addColorStop(1,'transparent');sx.fillStyle=g;sx.fillRect(0,0,sc.width,sc.height)}
for(const s of stars){s.tw+=s.sp;const a=.3+.7*Math.abs(Math.sin(s.tw));sx.beginPath();sx.arc(s.x,s.y,s.r*a,0,Math.PI*2);sx.fillStyle=`hsla(${s.h},60%,85%,${a*.8})`;sx.fill()}
requestAnimationFrame(dr)}
addEventListener('resize',rs);rs();dr()
})();

/* Main Game */
const Game=(()=>{
const STORY_S=["Your V-lasers carved a perfect path. The nebula map updates.","Sector cleared! Glaxonia Prime 3 tracking your progress.","Commander Vertex nods approvingly. Coordinates locked.","The coordinate nebula parts before you. Onward, pilot!","Stellar navigation on point. The Math Corps is impressed.","Another sector mapped. The Glaxonian frontier shrinks.","Your saucer's V-beams illuminate the void perfectly.","Control tower confirms: trajectory nominal. Well done, Cadet."];
const STORY_F=["Your lasers veered off course. The nebula swallowed them.","The Glaxonon patrol noted that deviation. Be more careful.","Commander Vertex sighs but signals to try the next sector.","The coordinate fog thickens. Don't lose your bearings."];
const RANKS=[{min:0,name:'Cadet',c:'#7a8ba8'},{min:300,name:'Navigator',c:'#60a5fa'},{min:800,name:'Pilot',c:'#34d399'},{min:1500,name:'Commander',c:'#a78bfa'},{min:2500,name:'Admiral',c:'#fbbf24'},{min:4000,name:'Legendary',c:'#ff6b5a'}];

let st={level:1,score:0,attempts:2,maxAttempts:2,a:null,h:null,k:null,aNum:null,aDen:null,aNeg:false,target:{x:0,y:0},slopeTarget:{x:0,y:0},solved:false,editingVar:null,levelHistory:[],combo:0};
let an={active:false,phase:'none',startTime:0,saucerX:0,saucerY:0,startPx:[0,0],endPx:[0,0],laserProgress:0,glowAlpha:0,hitP:[],hitR:[]};
const FLY=900,GLOW=500,LASER=600,HIT=900,HOLD=700;
let canvas,ctx,cW,cH,bounds={xMin:-10,xMax:10,yMin:-10,yMax:10},uPx=1;
const C={bg:'#0b0e17',grid:'rgba(60,80,130,.15)',gridA:'rgba(60,80,130,.25)',axis:'rgba(100,140,200,.4)',axLab:'rgba(130,160,210,.6)',tgt:'#ff5c5c',tgtG:'rgba(255,92,92,.2)',sT:'#5c9eff',sTG:'rgba(92,158,255,.2)',sG:'rgba(96,165,250,.5)',lC:'#39ff7f',lG:'rgba(57,255,127,.25)',lO:'rgba(57,255,127,.06)'};

function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function ff(n,d,neg){const s=neg?'‚àí':'';return d===1?s+n:s+n+'/'+d}

function genLevel(lv){
const diff=Math.min(Math.floor((lv-1)/2),6),range=Math.min(3+diff,8);
const cH=ri(-range,range),cK=ri(-range,range);
let aN,aD,aNg;
if(lv<=2){aN=[1,2][ri(0,1)];aD=1;aNg=false}
else if(lv<=4){aN=[1,2,3][ri(0,2)];aD=1;aNg=Math.random()<.3}
else if(lv<=7){const ch=[[1,1],[2,1],[1,2],[1,3],[2,3],[3,1]],p=ch[ri(0,ch.length-1)];aN=p[0];aD=p[1];aNg=Math.random()<.35}
else{const ch=[[1,1],[2,1],[3,1],[1,2],[1,3],[2,3],[3,2],[1,4],[3,4]],p=ch[ri(0,ch.length-1)];aN=p[0];aD=p[1];aNg=Math.random()<.4}
const cA=(aNg?-1:1)*aN/aD;
let dx,sY;
for(let i=0;i<20;i++){dx=ri(1,3)*(Math.random()<.5?1:-1);sY=cA*Math.abs(dx)+cK;if(Math.abs(sY-Math.round(sY))<.001)break}
sY=Math.round(sY);
return{target:{x:cH,y:cK},slopeTarget:{x:cH+dx,y:sY},correctH:cH,correctK:cK,correctA:cA,correctANum:aN,correctADen:aD,correctANeg:aNg}
}

function buildMission(tg,sl){
const dx=sl.x-tg.x,dy=sl.y-tg.y;
let v='',h='';
if(dy>0)v=Math.abs(dy)+' unit'+(Math.abs(dy)!==1?'s':'')+' up';
else if(dy<0)v=Math.abs(dy)+' unit'+(Math.abs(dy)!==1?'s':'')+' down';
if(dx>0)h=Math.abs(dx)+' unit'+(Math.abs(dx)!==1?'s':'')+' right';
else if(dx<0)h=Math.abs(dx)+' unit'+(Math.abs(dx)!==1?'s':'')+' left';
let o='';if(v&&h)o=v+' and '+h;else o=v||h||'at the vertex';
return 'Land vertex on ('+tg.x+', '+tg.y+') ¬∑ hit point '+o+' at ('+sl.x+', '+sl.y+')'
}

function getRank(s){let r=RANKS[0];for(const x of RANKS)if(s>=x.min)r=x;return r}

function init(){
canvas=document.getElementById('graph-canvas');ctx=canvas.getContext('2d');
addEventListener('resize',()=>{resizeCanvas();if(!an.active)draw()});
document.getElementById('eq-a').addEventListener('click',()=>openInput('a'));
document.getElementById('eq-h').addEventListener('click',()=>openInput('h'));
document.getElementById('eq-k').addEventListener('click',()=>openInput('k'));
document.getElementById('input-field').addEventListener('keydown',e=>{if(e.key==='Enter')confirmInput();if(e.key==='Escape')cancelInput()});
['frac-num','frac-den'].forEach(id=>{const f=document.getElementById(id);f.addEventListener('keydown',e=>{if(e.key==='Enter')confirmFraction();if(e.key==='Escape')cancelInput()});f.addEventListener('input',updateFP)});
loadState()
}

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function showTitle(){showScreen('title-screen');hideOverlays();const s=localStorage.getItem('vquest_state');document.getElementById('btn-continue').style.display=s?'inline-flex':'none'}
function showHow(){showScreen('how-screen')}
function showGame(){showScreen('game-screen');resizeCanvas();draw()}
function hideOverlays(){document.getElementById('level-complete').style.display='none';document.getElementById('level-failed').style.display='none'}

function startNew(){st.level=1;st.score=0;st.levelHistory=[];st.combo=0;saveState();setupLevel();showGame()}
function continueGame(){loadState();setupLevel();showGame()}

function setupLevel(){
const lv=genLevel(st.level);st.target=lv.target;st.slopeTarget=lv.slopeTarget;
st.attempts=st.maxAttempts;st.solved=false;st.a=null;st.h=null;st.k=null;
st.aNum=null;st.aDen=null;st.aNeg=false;st.editingVar=null;
st._c={h:lv.correctH,k:lv.correctK,a:lv.correctA,aN:lv.correctANum,aD:lv.correctADen,aNg:lv.correctANeg};
an.active=false;an.phase='none';
const coords=[Math.abs(st.target.x),Math.abs(st.target.y),Math.abs(st.slopeTarget.x),Math.abs(st.slopeTarget.y)];
const mx=Math.max(...coords,6)+2,b=Math.min(Math.max(mx,7),14);
bounds={xMin:-b,xMax:b,yMin:-b,yMax:b};
document.getElementById('mission-text').textContent=buildMission(st.target,st.slopeTarget);
updateUI();hideOverlays();hideFB();draw()
}

function updateUI(){
document.getElementById('level-number').textContent='Level '+st.level;
document.getElementById('score-display').textContent=st.score;
document.getElementById('attempts-display').textContent=st.attempts;
const rk=getRank(st.score),rb=document.getElementById('rank-badge');
rb.textContent=rk.name;rb.style.color=rk.c;rb.style.borderColor=rk.c+'33';rb.style.background=rk.c+'15';
const cd=document.getElementById('combo-display');
if(st.combo>=2){cd.textContent='üî• COMBO x'+st.combo;cd.classList.add('visible')}else cd.classList.remove('visible');
const eA=document.getElementById('eq-a'),eH=document.getElementById('eq-h'),eK=document.getElementById('eq-k');
if(st.a===null){eA.textContent='a';eA.classList.add('placeholder')}else{eA.textContent=ff(st.aNum,st.aDen,st.aNeg);eA.classList.remove('placeholder')}
if(st.h===null){eH.textContent='h';eH.classList.add('placeholder')}else{eH.textContent=st.h;eH.classList.remove('placeholder')}
if(st.k===null){eK.textContent='k';eK.classList.add('placeholder')}else{eK.textContent=st.k;eK.classList.remove('placeholder')}
}

function openInput(v){
if(st.solved||an.active)return;st.editingVar=v;
['eq-a','eq-h','eq-k'].forEach(id=>document.getElementById(id).classList.remove('active'));
document.getElementById('eq-'+v).classList.add('active');
if(v==='a'){
document.getElementById('input-modal').style.display='none';
const fm=document.getElementById('frac-modal'),n=document.getElementById('frac-num'),d=document.getElementById('frac-den'),sg=document.getElementById('frac-sign');
n.value=st.aNum!==null?st.aNum:'';d.value=st.aDen!==null?st.aDen:'';
sg.textContent=st.aNeg?'‚àí':'+';sg.classList.toggle('negative',st.aNeg);
fm.style.display='block';updateFP();setTimeout(()=>n.focus(),50)
}else{
document.getElementById('frac-modal').style.display='none';
const m=document.getElementById('input-modal'),l=document.getElementById('input-label'),f=document.getElementById('input-field');
l.textContent='Set value for '+v+':';f.value=st[v]!==null?st[v]:'';f.placeholder='0';
m.style.display='block';setTimeout(()=>{f.focus();f.select()},50)
}
}

function confirmInput(){const f=document.getElementById('input-field'),v=parseInt(f.value,10);if(isNaN(v))return;st[st.editingVar]=Math.max(-15,Math.min(15,v));closeInput();updateUI()}
function toggleFracSign(){st.aNeg=!st.aNeg;const e=document.getElementById('frac-sign');e.textContent=st.aNeg?'‚àí':'+';e.classList.toggle('negative',st.aNeg);updateFP()}
function updateFP(){const n=parseInt(document.getElementById('frac-num').value,10),d=parseInt(document.getElementById('frac-den').value,10),p=document.getElementById('frac-preview');if(!isNaN(n)&&!isNaN(d)&&d!==0){const s=st.aNeg?'-':'',v=(st.aNeg?-1:1)*n/d;p.textContent=d===1?'a = '+s+n+' (= '+v+')':'a = '+s+n+'/'+d+' (‚âà '+v.toFixed(2)+')'}else p.textContent=''}
function confirmFraction(){const n=parseInt(document.getElementById('frac-num').value,10),d=parseInt(document.getElementById('frac-den').value,10);if(isNaN(n)||isNaN(d)||d===0||n<0||d<0){document.getElementById('frac-preview').textContent='Enter positive whole numbers';return}st.aNum=Math.abs(n);st.aDen=Math.abs(d);st.a=(st.aNeg?-1:1)*st.aNum/st.aDen;closeInput();updateUI()}
function cancelInput(){closeInput()}
function closeInput(){document.getElementById('input-modal').style.display='none';document.getElementById('frac-modal').style.display='none';['eq-a','eq-h','eq-k'].forEach(id=>document.getElementById(id).classList.remove('active'));st.editingVar=null}

function trySolution(){
if(st.solved||st.attempts<=0||an.active)return;
if(st.a===null||st.h===null||st.k===null){showFB('‚úèÔ∏è Set a, h, and k first!','fail');return}
st.attempts--;updateUI();
const vOK=st.h===st.target.x&&st.k===st.target.y;
const eY=st.a*Math.abs(st.slopeTarget.x-st.h)+st.k;
const sOK=Math.abs(eY-st.slopeTarget.y)<.001;
startAnim(vOK&&sOK)
}

/* Animation */
function startAnim(ok){
an.active=true;an.phase='fly';an.startTime=performance.now();an.isCorrect=ok;
const[ex,ey]=toPixel(st.h,st.k);an.startPx=[cW/2,-40];an.endPx=[ex,ey];
an.saucerX=an.startPx[0];an.saucerY=an.startPx[1];an.laserProgress=0;an.glowAlpha=0;an.hitP=[];an.hitR=[];
document.getElementById('btn-try').disabled=true;requestAnimationFrame(animLoop)
}

function animLoop(ts){
if(!an.active)return;const el=ts-an.startTime;
switch(an.phase){
case'fly':{const t=Math.min(el/FLY,1),e=1-Math.pow(1-t,3);an.saucerX=an.startPx[0]+(an.endPx[0]-an.startPx[0])*e;an.saucerY=an.startPx[1]+(an.endPx[1]-an.startPx[1])*e;an.saucerX+=Math.sin(el*.015)*4*(1-t);if(t>=1){an.phase='glow';an.startTime=ts;an.saucerX=an.endPx[0];an.saucerY=an.endPx[1]}break}
case'glow':{const t=Math.min(el/GLOW,1);an.glowAlpha=t<.4?t/.4:1;if(t>=1){an.phase='laser';an.startTime=ts}break}
case'laser':{const t=Math.min(el/LASER,1);an.laserProgress=1-Math.pow(1-t,2);if(t>=1){an.laserProgress=1;if(an.isCorrect){an.phase='hit';an.startTime=ts;mkHit();document.getElementById('canvas-wrapper').classList.add('shake');setTimeout(()=>document.getElementById('canvas-wrapper').classList.remove('shake'),500)}else{an.phase='hold';an.startTime=ts}}break}
case'hit':{const t=Math.min(el/HIT,1);updHit(t);if(t>=1){an.phase='hold';an.startTime=ts}break}
case'hold':{const t=Math.min(el/HOLD,1);if(t>=1){an.phase='done';an.active=false;document.getElementById('btn-try').disabled=false;onDone();return}break}
}
drawAF();requestAnimationFrame(animLoop)
}

function mkHit(){
const[tx,ty]=toPixel(st.slopeTarget.x,st.slopeTarget.y);an.hitP=[];an.hitR=[];
const cols=['#fbbf24','#f59e0b','#ef4444','#22c55e','#3b82f6','#a78bfa','#ec4899','#39ff7f'];
for(let i=0;i<36;i++){const ag=(Math.PI*2*i)/36+(Math.random()-.5)*.3,sp=50+Math.random()*120;an.hitP.push({x:tx,y:ty,vx:Math.cos(ag)*sp,vy:Math.sin(ag)*sp,r:1.5+Math.random()*4,c:cols[i%cols.length],a:1})}
for(let i=0;i<3;i++)an.hitR.push({x:tx,y:ty,r:5,mr:50+i*30,a:.6,d:i*.1})
}

function updHit(t){for(const p of an.hitP){p.x+=p.vx*.018;p.y+=p.vy*.018;p.vy+=.8;p.a=Math.max(0,1-t*1.1);p.r*=.985}for(const r of an.hitR){const rt=Math.max(0,t-r.d)/(1-r.d);r.r=5+(r.mr-5)*Math.min(rt,1);r.a=.6*Math.max(0,1-rt)}}

function drawAF(){if(!ctx)return;ctx.clearRect(0,0,cW,cH);drawBG();drawGrid();drawAxes();drawTgt();drawSTgt();
if(['laser','hit','hold'].includes(an.phase))drawLasers(an.saucerX,an.saucerY,st.h,st.k,st.a,an.laserProgress);
if(['hit','hold'].includes(an.phase)&&an.hitP.length)drawHitFX();
if(an.glowAlpha>0)drawSGlow(an.saucerX,an.saucerY,an.glowAlpha);
drawSaucer(an.saucerX,an.saucerY,an.phase)}

function drawHitFX(){ctx.save();
for(const r of an.hitR){if(r.a<=0)continue;ctx.beginPath();ctx.arc(r.x,r.y,r.r,0,Math.PI*2);ctx.strokeStyle='rgba(251,191,36,'+r.a+')';ctx.lineWidth=2;ctx.stroke()}
for(const p of an.hitP){if(p.a<=0)continue;ctx.globalAlpha=p.a;ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,Math.max(.5,p.r),0,Math.PI*2);ctx.fill()}
ctx.globalAlpha=1;
const[tx,ty]=toPixel(st.slopeTarget.x,st.slopeTarget.y);const el=performance.now()-an.startTime,t=Math.min(el/HIT,1),fa=.7*Math.max(0,1-t*2);
if(fa>0){const g=ctx.createRadialGradient(tx,ty,0,tx,ty,40);g.addColorStop(0,'rgba(255,255,255,'+fa+')');g.addColorStop(.3,'rgba(251,191,36,'+(fa*.5)+')');g.addColorStop(1,'rgba(251,191,36,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(tx,ty,40,0,Math.PI*2);ctx.fill()}
ctx.restore()}

function onDone(){
if(an.isCorrect){
st.solved=true;st.combo++;const stars=st.attempts+1,cb=Math.max(0,(st.combo-1)*50),pts=stars*100+cb;
st.score+=pts;st.levelHistory.push(stars);saveState();updateUI();showPtPop('+'+pts);
showFB('üéØ Direct hit! Mission complete!','success');setTimeout(()=>showLC(stars,pts),1200)
}else{
st.combo=0;
if(st.attempts>0){showFB('‚úï '+genHint(),'fail');setTimeout(()=>draw(),200)}
else{showFB('‚úï Out of tries!','fail');setTimeout(()=>showLF(),1000)}
updateUI()
}}

function showPtPop(txt){const p=document.createElement('div');p.className='point-popup';p.textContent=txt;p.style.left='50%';p.style.top='40%';p.style.transform='translateX(-50%)';document.getElementById('canvas-wrapper').appendChild(p);setTimeout(()=>p.remove(),1300)}

/* Drawing */
function drawSaucer(sx,sy,ph){ctx.save();ctx.translate(sx,sy);if(ph!=='fly')ctx.translate(0,Math.sin(performance.now()*.005)*2.5);
ctx.beginPath();ctx.ellipse(0,0,24,9,0,0,Math.PI*2);const bg=ctx.createLinearGradient(-24,-9,24,9);bg.addColorStop(0,'#5a6577');bg.addColorStop(.3,'#d1d5db');bg.addColorStop(.5,'#f3f4f6');bg.addColorStop(.7,'#d1d5db');bg.addColorStop(1,'#5a6577');ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle='rgba(200,220,255,.3)';ctx.lineWidth=1;ctx.stroke();
ctx.beginPath();ctx.ellipse(0,-4,12,12,0,Math.PI,0);const dg=ctx.createRadialGradient(0,-10,2,0,-7,13);dg.addColorStop(0,'rgba(96,165,250,.95)');dg.addColorStop(.5,'rgba(96,165,250,.4)');dg.addColorStop(1,'rgba(96,165,250,.05)');ctx.fillStyle=dg;ctx.fill();ctx.strokeStyle='rgba(96,165,250,.4)';ctx.lineWidth=.8;ctx.stroke();
const lc=['#ff5c5c','#39ff7f','#fbbf24','#a78bfa','#22d3ee'];for(let i=-2;i<=2;i++){ctx.beginPath();ctx.arc(i*9,4,2.2,0,Math.PI*2);const fl=Math.sin(performance.now()*.009+i*1.8)>0?1:.2;ctx.fillStyle=lc[(i+2)%lc.length];ctx.globalAlpha=fl;ctx.fill();ctx.globalAlpha=1}
if(['glow','laser','hit','hold'].includes(ph)){ctx.beginPath();ctx.moveTo(-5,9);ctx.lineTo(5,9);ctx.lineTo(0,15);ctx.closePath();ctx.fillStyle=C.lC;ctx.globalAlpha=.5+.5*Math.sin(performance.now()*.012);ctx.fill();ctx.globalAlpha=1}
ctx.restore()}

function drawSGlow(sx,sy,a){ctx.save();const g=ctx.createRadialGradient(sx,sy,3,sx,sy,55);g.addColorStop(0,'rgba(96,165,250,'+(0.45*a)+')');g.addColorStop(.4,'rgba(57,255,127,'+(0.15*a)+')');g.addColorStop(1,'rgba(57,255,127,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(sx,sy,55,0,Math.PI*2);ctx.fill();ctx.restore()}

function drawLasers(sx,sy,h,k,a,prog){const[vx,vy]=toPixel(h,k);const mx=Math.max(cW,cH)*1.5;
const rDx=uPx,rDy=-a*uPx,rL=Math.sqrt(rDx*rDx+rDy*rDy),rEx=vx+(rDx/rL)*mx,rEy=vy+(rDy/rL)*mx;
const lDx=-uPx,lDy=-a*uPx,lL=Math.sqrt(lDx*lDx+lDy*lDy),lEx=vx+(lDx/lL)*mx,lEy=vy+(lDy/lL)*mx;
const rCx=vx+(rEx-vx)*prog,rCy=vy+(rEy-vy)*prog,lCx=vx+(lEx-vx)*prog,lCy=vy+(lEy-vy)*prog;
ctx.save();ctx.lineCap='round';
ctx.strokeStyle=C.lO;ctx.lineWidth=14;ctx.beginPath();ctx.moveTo(vx,vy);ctx.lineTo(rCx,rCy);ctx.stroke();ctx.beginPath();ctx.moveTo(vx,vy);ctx.lineTo(lCx,lCy);ctx.stroke();
ctx.strokeStyle=C.lG;ctx.lineWidth=7;ctx.beginPath();ctx.moveTo(vx,vy);ctx.lineTo(rCx,rCy);ctx.stroke();ctx.beginPath();ctx.moveTo(vx,vy);ctx.lineTo(lCx,lCy);ctx.stroke();
ctx.strokeStyle=C.lC;ctx.lineWidth=2.5;ctx.shadowColor=C.lC;ctx.shadowBlur=10;ctx.beginPath();ctx.moveTo(vx,vy);ctx.lineTo(rCx,rCy);ctx.stroke();ctx.beginPath();ctx.moveTo(vx,vy);ctx.lineTo(lCx,lCy);ctx.stroke();
ctx.shadowBlur=0;ctx.restore()}

function genHint(){const{a:ca,h:ch,k:ck}=st._c;
if(st.h!==ch&&st.k!==ck)return st.h<ch?'Move h to the right.':'Move h to the left.';
if(st.h!==ch)return st.h<ch?'Shift h right.':'Shift h left.';
if(st.k!==ck)return st.k<ck?'Move k up.':'Move k down.';
if(Math.abs(st.a-ca)>.001){if(Math.abs(st.a)<Math.abs(ca))return'Steeper! Increase the rise.';if(Math.abs(st.a)>Math.abs(ca))return'Less steep ‚Äî smaller rise or bigger run.';if(st.a>0&&ca<0)return'Flip the sign ‚Äî try negative.';if(st.a<0&&ca>0)return'Open upward ‚Äî try positive.';return'Adjust the slope (a).'}
return'Very close! Double-check everything.'}

function showFB(m,t){const e=document.getElementById('feedback-toast');e.style.display='flex';e.className='feedback-toast '+t;document.getElementById('feedback-msg').textContent=m;clearTimeout(showFB._t);showFB._t=setTimeout(hideFB,3500)}
function hideFB(){document.getElementById('feedback-toast').style.display='none'}

function showLC(stars,pts){hideFB();document.getElementById('level-complete').style.display='flex';
document.querySelectorAll('#stars-row .star').forEach((e,i)=>{e.classList.remove('earned');if(i<stars)setTimeout(()=>e.classList.add('earned'),200+i*250)});
document.getElementById('complete-title').textContent='Mission Success!';
document.getElementById('complete-msg').textContent='All of Glaxonia Prime 3 salutes you.';
document.getElementById('story-progress').textContent=STORY_S[(st.level-1)%STORY_S.length];
document.getElementById('complete-points').textContent='+'+pts;
document.getElementById('complete-attempts').textContent=(st.maxAttempts-st.attempts)+'/'+st.maxAttempts;
document.getElementById('complete-combo').textContent='x'+st.combo}

function showLF(){hideFB();document.getElementById('level-failed').style.display='flex';const c=st._c;
document.getElementById('fail-msg').textContent='Glaxonon police put you in Xinothropic Galactic Jail for 2 parsecs.';
document.getElementById('fail-answer').textContent='Answer: a = '+ff(c.aN,c.aD,c.aNg)+', h = '+c.h+', k = '+c.k;
document.getElementById('fail-story').textContent=STORY_F[(st.level-1)%STORY_F.length]}

function nextLevel(){st.level++;saveState();setupLevel();showGame()}
function retryLevel(){st.combo=0;setupLevel();hideOverlays()}
function saveState(){try{localStorage.setItem('vquest_state',JSON.stringify({level:st.level,score:st.score,levelHistory:st.levelHistory,combo:st.combo}))}catch(e){}}
function loadState(){try{const r=localStorage.getItem('vquest_state');if(r){const s=JSON.parse(r);st.level=s.level||1;st.score=s.score||0;st.levelHistory=s.levelHistory||[];st.combo=s.combo||0}}catch(e){}}

/* Canvas */
function resizeCanvas(){const w=document.getElementById('canvas-wrapper'),d=devicePixelRatio||1;cW=w.clientWidth;cH=w.clientHeight;canvas.width=cW*d;canvas.height=cH*d;canvas.style.width=cW+'px';canvas.style.height=cH+'px';ctx.setTransform(d,0,0,d,0,0);uPx=Math.min(cW/(bounds.xMax-bounds.xMin),cH/(bounds.yMax-bounds.yMin))}
function toPixel(mx,my){return[cW/2+mx*uPx,cH/2-my*uPx]}

function draw(){if(!ctx)return;ctx.clearRect(0,0,cW,cH);drawBG();drawGrid();drawAxes();drawTgt();drawSTgt()}

function drawBG(){
/* Subtle space watermark behind grid */
const cx=cW/2,cy=cH/2;
const g=ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(cW,cH)*.6);
g.addColorStop(0,'rgba(20,30,60,.15)');g.addColorStop(.5,'rgba(15,20,40,.08)');g.addColorStop(1,'rgba(10,15,25,0)');
ctx.fillStyle=g;ctx.fillRect(0,0,cW,cH);
/* Subtle planet watermark */
const t=Date.now()*.00003;
const px=cW*.75+Math.sin(t)*20,py=cH*.25+Math.cos(t*.7)*15;
const pg=ctx.createRadialGradient(px,py,5,px,py,60);
pg.addColorStop(0,'rgba(96,165,250,.06)');pg.addColorStop(.5,'rgba(96,165,250,.03)');pg.addColorStop(1,'transparent');
ctx.fillStyle=pg;ctx.fillRect(0,0,cW,cH);
/* Ring around planet */
ctx.save();ctx.translate(px,py);ctx.scale(1,.3);ctx.beginPath();ctx.arc(0,0,55,0,Math.PI*2);ctx.strokeStyle='rgba(96,165,250,.04)';ctx.lineWidth=8;ctx.stroke();ctx.restore()
}

function drawGrid(){ctx.strokeStyle=C.grid;ctx.lineWidth=1;
for(let x=Math.ceil(bounds.xMin);x<=bounds.xMax;x++){const[px]=toPixel(x,0);if(x%5===0){ctx.strokeStyle=C.gridA;ctx.lineWidth=1.2}else{ctx.strokeStyle=C.grid;ctx.lineWidth=.8}ctx.beginPath();ctx.moveTo(px,0);ctx.lineTo(px,cH);ctx.stroke()}
for(let y=Math.ceil(bounds.yMin);y<=bounds.yMax;y++){const[,py]=toPixel(0,y);if(y%5===0){ctx.strokeStyle=C.gridA;ctx.lineWidth=1.2}else{ctx.strokeStyle=C.grid;ctx.lineWidth=.8}ctx.beginPath();ctx.moveTo(0,py);ctx.lineTo(cW,py);ctx.stroke()}}

function drawAxes(){const[ox,oy]=toPixel(0,0);ctx.strokeStyle=C.axis;ctx.lineWidth=1.5;
ctx.beginPath();ctx.moveTo(0,oy);ctx.lineTo(cW,oy);ctx.stroke();
ctx.beginPath();ctx.moveTo(ox,0);ctx.lineTo(ox,cH);ctx.stroke();
ctx.fillStyle=C.axLab;ctx.font='11px "DM Mono",monospace';
ctx.textAlign='center';ctx.textBaseline='top';
for(let x=Math.ceil(bounds.xMin);x<=bounds.xMax;x++){if(x===0)continue;const[px]=toPixel(x,0);ctx.beginPath();ctx.moveTo(px,oy-3);ctx.lineTo(px,oy+3);ctx.strokeStyle=C.axis;ctx.lineWidth=1;ctx.stroke();ctx.fillText(x,px,oy+6)}
ctx.textAlign='right';ctx.textBaseline='middle';
for(let y=Math.ceil(bounds.yMin);y<=bounds.yMax;y++){if(y===0)continue;const[,py]=toPixel(0,y);ctx.beginPath();ctx.moveTo(ox-3,py);ctx.lineTo(ox+3,py);ctx.strokeStyle=C.axis;ctx.lineWidth=1;ctx.stroke();ctx.fillText(y,ox-7,py)}
ctx.textAlign='right';ctx.textBaseline='top';ctx.fillText('0',ox-5,oy+5)}

function drawTgt(){const[tx,ty]=toPixel(st.target.x,st.target.y);
ctx.beginPath();ctx.arc(tx,ty,14,0,Math.PI*2);ctx.fillStyle=C.tgtG;ctx.fill();
const p=1+.15*Math.sin(Date.now()/300);ctx.beginPath();ctx.arc(tx,ty,10*p,0,Math.PI*2);ctx.strokeStyle=C.tgt;ctx.lineWidth=2;ctx.stroke();
ctx.beginPath();ctx.arc(tx,ty,4,0,Math.PI*2);ctx.fillStyle=C.tgt;ctx.fill();
ctx.fillStyle=C.tgt;ctx.font='600 12px "Outfit",sans-serif';ctx.textAlign='left';ctx.textBaseline='bottom';ctx.fillText('('+st.target.x+', '+st.target.y+')',tx+14,ty-6);
if(!an.active)requestAnimationFrame(draw)}

function drawSTgt(){const[tx,ty]=toPixel(st.slopeTarget.x,st.slopeTarget.y);
ctx.beginPath();ctx.arc(tx,ty,12,0,Math.PI*2);ctx.fillStyle=C.sTG;ctx.fill();
const p=1+.12*Math.sin(Date.now()/350+1),sz=7*p;
ctx.beginPath();ctx.moveTo(tx,ty-sz);ctx.lineTo(tx+sz,ty);ctx.lineTo(tx,ty+sz);ctx.lineTo(tx-sz,ty);ctx.closePath();ctx.strokeStyle=C.sT;ctx.lineWidth=2;ctx.stroke();
ctx.beginPath();ctx.arc(tx,ty,3,0,Math.PI*2);ctx.fillStyle=C.sT;ctx.fill();
ctx.fillStyle=C.sT;ctx.font='600 12px "Outfit",sans-serif';ctx.textAlign='left';ctx.textBaseline='bottom';ctx.fillText('('+st.slopeTarget.x+', '+st.slopeTarget.y+')',tx+14,ty-6)}

document.addEventListener('DOMContentLoaded',()=>{init();showTitle()});
return{startNew,continueGame,showTitle,showHow,trySolution,confirmInput,cancelInput,confirmFraction,toggleFracSign,nextLevel,retryLevel}
})();
</script>
</body>
</html>
